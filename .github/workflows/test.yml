name: test

on: [push, pull_request]

concurrency: # Cancel stale PR builds (but not push builds)
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        nim_version:
          - stable
          - devel
    defaults:
      run:
        shell: bash

    name: Test ${{ matrix.os }} (Nim ${{ matrix.nim_version }})
    steps:
      - name: Set git to use LF
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set cache-key
        id: vars
        run: echo "cache-key=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Cache nimble
        id: cache-nimble
        uses: actions/cache@v4
        with:
          path: ~/.nimble
          key: ${{ runner.os }}-nimble-${{ hashFiles('*.nimble') }}

      - name: Download and setup Nim DLLs (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          SEC=9; ok=0; URL=https://nim-lang.org/download/dlls.zip
          for i in {1..5}; do
            curl -sfL --retry 3 --retry-delay 2 -o dlls.zip "$URL" || {
              echo "ATTEMPT $i: CURL FAILED"; sleep $SEC; continue; }
            unzip -t dlls.zip >/dev/null 2>&1 && {
              unzip dlls.zip -d nim-dlls; ok=1; break; }
            echo "ATTEMPT $i: BAD ZIP"; rm -f dlls.zip; sleep $SEC
          done
          [ "$ok" -ne 1 ] && { echo "FAILED TO GET VALID dlls.zip"; exit 1; }
          echo "$GITHUB_WORKSPACE/nim-dlls" >> $GITHUB_PATH
          echo "SSL_CERT_FILE=$GITHUB_WORKSPACE/nim-dlls/cacert.pem" >> $GITHUB_ENV

      - name: Install make (Windows)
        if: runner.os == 'Windows'
        run: choco install make -y --no-progress

      - uses: nim-lang/setup-nimble-action@v1
        with:
          nimble-version: '0.20.1'
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nim and add to PATH
        run: |
          if [ "${{ matrix.nim_version }}" == "stable" ]; then
            nimble install nim --latest -y
          else
            nimble install 'nim@#devel' -y
          fi
          # Find where nimble actually installed nim (in .nimble/nimbinaries/nim-VERSION/bin/)
          NIM_BIN=$(find $HOME/.nimble/nimbinaries -name nim -type f 2>/dev/null | head -1)
          if [ -n "$NIM_BIN" ]; then
            NIM_BIN_DIR=$(dirname "$NIM_BIN")
            echo "Found nim at: $NIM_BIN"
            echo "$NIM_BIN_DIR" >> $GITHUB_PATH
          fi
          echo "$HOME/.nimble/bin" >> $GITHUB_PATH

      - name: Test
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            make V=1 -j 1
          else
            make V=1 -j $(nproc)
          fi
        env:
          DIFF: diff -u
